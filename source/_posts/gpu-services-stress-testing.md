---
title: GPU 密集服务的压测目标是什么
date: 2022-08-09 23:56:16
tags: GPU,压力测试,JMeter
---

TL;DR:

GPU 密集型服务的压测目标是：检验服务的每分钟计算任务数量是否逼近 `一分钟内计算次数 * batch_size * GPU 数量`，且服务能长时间保持稳定。

## 颟顸的准备压测方案

上周四开始准备新接口的压测方案，这周二需要出压测结果。说实话，WebSocket、JMeter 以及「压测」对我来说都是新鲜东西，虽然这事儿没什么写代码的压力，但是把一个新鲜的事情做到让同事或者 Leader 认为达到 60 分的水平，对我来说还是挺有压力的（这里有一个观点是很多时候你认为做到 95% 以上时你的 Leader 可能只觉得你做的刚及格甚至离及格还差一点，我认同这个观点，并且不认为这个是 PUA，关于这个话题之后再开一篇 Blog 来聊吧）。然后我就带着一点点压力颟颟顸顸的开始准备压测方案了。

### 先列一下我得到的需求：

- 我们的目标是第一阶段支持 xx QPS, 第二阶段支持 xxx QPS
- 我们该如何保障？压测方案是什么？

### 我是怎么准备的：

*Naive 预警*

- 第一阶段：
  - xx QPS 那就需要模拟 xx 个用户来并发。
- 第二阶段：
  - 在 liluo 的提醒下要清楚 xx 个用户并发和 QPS 之间的关系（他们并不是一个概念），思考之后我认为我们现在需要测试的是服务的 QPM，因为我们单次请求时长的单位为秒。
- 第三个阶段：
  - 突然想到了算法同事做过单张 RTX 3080 Ti 的压力测试，当时个结果为 x QPS，测试目标又改为并发 `x QPS * GPU 数量` 个请求检验服务是否可以稳定响应，压力提高（并发增加）时候是否可以稳定响应。

我是按照第三个阶段的想法进行压测准备的。

### 以上准备过程中的缺失：

1. 混淆概念，QPS 这个概念不该用到这里，*QPS*：Queries Per Second意思是“每秒查询率”，QPM 亦是。
2. 没有搞清楚压测目标就想压测方案，正确的压测目标应该是 Blog 开头提到的目标，然而这个目标我现在才想清楚。
3. 是通过读以上内容看不出来的，我是在学习 JMeter 如何使用的过程中，边学边准备压测方案的，现在想一下这个也是让我没有系统性的思考、准备压测方案的重要原因，人的脑子只能不受干扰的认真做一件事情。
4. 和 Leader 沟通不够及时、充分，自己认为有疑惑应该提出来一起讨论，颟顸的决定势必要埋下隐患。



## 正确的压测方案应该是？

1. 屏蔽 GPU 相关的服务，仅仅检测 WebSocket、DB、Redis 是否满足目标并发？
2. 明确 WebSocket、DB、Redis 满足目标并发的最小资源占用是多少？
3. 测试单个 `batch` 计算时长；即可评估 1min 内可计算 batch 数量。
4. 准备 `batch_size * GPU`  数量个并发请求，请求数量为 `压测时长 * 1min 内可计算 batch 数量`，作为基本压测方案，要检验服务能不能平稳的抗住这个压力。
5. 基于基本压测方案再准备若干个小的并发请求和大的并发请求（负载低，和负载高的情况）
6. 开始压测，JMeter 能生成详细的报告。



确定了 `batch_size` 其实就是确定了能够「榨干」GPU 计算资源的数据量是多少，所以压测时候不需要再评估要模拟的并发数量是多少，这个数量是确定的，只存在达不到这个并发数量，不可能测出超过这个并发数量的结果。

原本还想分析一下今天压测结果与目标结果之间的差距可能是受哪些因素影响，写到一半发现我想得都仅仅是我推测，还是实验之后再写出来吧。
